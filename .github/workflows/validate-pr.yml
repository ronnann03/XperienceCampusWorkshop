name: âœ… Validate PR

# Se ejecuta solo en Pull Requests que modifican contributors/
on:
  pull_request:
    branches:
      - main
    paths:
      - "contributors/**"

permissions:
  contents: read
  pull-requests: write

jobs:
  validate:
    name: Validate contribution
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout del PR
      - name: ğŸ“¥ Checkout PR
        uses: actions/checkout@v4

      # 2. Setup de Node.js
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # 3. Validar archivos JSON
      - name: âœ… Validate JSON files
        id: validate
        run: |
          echo "Validando archivos de colaboradores..."
          
          # Ejecutar el generador (valida automÃ¡ticamente)
          if node scripts/generate-contributors.js; then
            echo "validation=success" >> $GITHUB_OUTPUT
            echo "âœ… ValidaciÃ³n exitosa"
          else
            echo "validation=failed" >> $GITHUB_OUTPUT
            echo "âŒ ValidaciÃ³n fallida"
            exit 1
          fi

      # 4. Comentar en el PR si es exitoso
      - name: ğŸ’¬ Comment success
        if: steps.validate.outputs.validation == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## âœ… ValidaciÃ³n Exitosa

              Â¡Tu contribuciÃ³n ha sido validada correctamente! ğŸ‰

              **Siguiente paso:** Un maintainer revisarÃ¡ y mergearÃ¡ tu PR.

              Una vez mergeado:
              - ğŸ¤– GitHub Actions generarÃ¡ automÃ¡ticamente \`public/index.json\`
              - ğŸš€ Tu perfil se desplegarÃ¡ automÃ¡ticamente a GitHub Pages
              - ğŸŒ AparecerÃ¡s en: https://dav082004.github.io/XperienceCampusWorkshop/

              Â¡Gracias por contribuir! ğŸ™Œ`
            })

      # 5. Comentar en el PR si fallÃ³
      - name: ğŸ’¬ Comment failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## âŒ ValidaciÃ³n Fallida

              Hubo errores en la validaciÃ³n de tu contribuciÃ³n.

              **Por favor revisa:**
              - âœ… Tu archivo JSON tiene sintaxis vÃ¡lida
              - âœ… Incluye los campos obligatorios: \`name\`, \`nickname\`, \`hobbies\`
              - âœ… El array \`hobbies\` tiene entre 1 y 4 elementos
              - âœ… La descripciÃ³n tiene mÃ¡ximo 150 caracteres

              **Verifica los logs arriba** â¬†ï¸ para ver los errores especÃ­ficos.

              Una vez corregido, solo haz commit y push - este workflow se ejecutarÃ¡ automÃ¡ticamente.`
            })
